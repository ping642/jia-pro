<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ğŸ„ å®¶åº­ä¹å›­ Â· æ™ºèƒ½é€‚é…ç‰ˆ</title>
    <!-- FontAwesome 5 å›¾æ ‡åº“ (å…è´¹) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #1e2a3a;
        }
        /* é¡¶éƒ¨å¯¼èˆª + ç”¨æˆ·ä¿¡æ¯ */
        .app-bar {
            background: #2e405b;
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .logo {
            font-weight: 600;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }
        .logo i {
            margin-right: 6px;
            color: #ffd966;
        }
        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .coin-badge {
            background: #f1c40f;
            color: #2d3e50;
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .user-selector {
            background: #3b4f6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .user-selector option { background: white; color: black; }
        /* ä¸»é€‰é¡¹å¡å¯¼èˆª */
        .nav-tabs {
            display: flex;
            background: white;
            padding: 0.5rem 1rem 0;
            gap: 0.2rem 1rem;
            border-bottom: 2px solid #d0dae8;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .nav-tab {
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            color: #5e6f88;
            border-radius: 30px 30px 0 0;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 3px solid transparent;
            background: transparent;
            white-space: nowrap;
        }
        .nav-tab i { margin-right: 6px; }
        .nav-tab.active {
            color: #2e405b;
            border-bottom: 3px solid #2e405b;
            background: #e8ecf3;
        }
        /* ä¸»å†…å®¹åŒº â€” é¢æ¿åˆ‡æ¢ */
        .panel-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f0f2f5;
        }
        .panel {
            display: none;
            height: 100%;
            overflow-y: auto;
        }
        .panel.active-panel {
            display: block;
        }
        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 20px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1e2f40;
        }
        /* èŠå¤©åŒºåŸŸ */
        .chat-messages {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid #e0e6ed;
            border-radius: 24px;
            padding: 1rem;
            background: #f9fafc;
            margin-bottom: 1rem;
        }
        .message {
            display: flex;
            margin-bottom: 1rem;
            align-items: flex-start;
            gap: 10px;
        }
        .msg-avatar {
            width: 36px; height: 36px;
            background: #2e405b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        .msg-bubble {
            background: white;
            border-radius: 18px 18px 18px 4px;
            padding: 10px 16px;
            max-width: 80%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #dee5f0;
        }
        .msg-info { font-size: 0.8rem; color: #7b8ba0; margin-bottom: 4px; display: flex; gap: 10px; }
        .redpacket {
            background: #fee9b0;
            border: 1px solid #f1c40f;
            border-radius: 16px;
            padding: 10px;
            cursor: pointer;
            transition: 0.1s;
        }
        .redpacket:active { background: #f9d77e; }
        .redpacket.grabbed { opacity: 0.6; pointer-events: none; }
        .chat-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        .chat-input {
            flex: 1 1 200px;
            padding: 12px 16px;
            border-radius: 30px;
            border: 1px solid #ccd8e8;
            outline: none;
        }
        .emojis span {
            font-size: 1.6rem;
            cursor: pointer;
            margin: 0 2px;
        }
        .btn {
            background: #eef3f9;
            border: none;
            padding: 8px 14px;
            border-radius: 40px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.1s;
        }
        .btn-primary {
            background: #2e405b;
            color: white;
        }
        /* äº‘ç›˜æ–‡ä»¶ç½‘æ ¼ */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 1rem;
        }
        .file-item {
            background: #f6f9ff;
            border-radius: 20px;
            padding: 1rem;
            border: 1px solid #dde3ed;
            transition: 0.2s;
        }
        .file-icon { font-size: 2.2rem; color: #4f6f9f; }
        .file-name { font-weight: 500; word-break: break-word; }
        .file-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .file-actions .btn { padding: 4px 10px; font-size: 0.8rem; }
        /* æ‰‹æœºä¸“ç”¨éšè—ç”µè„‘æ“ä½œ */
        body.mobile .desktop-only { display: none !important; }
        /* ç”µè„‘æ˜¾ç¤ºæ­£å¸¸ï¼Œæ‰‹æœºä¹Ÿå¯ä»¥å¼ºåˆ¶æ˜¾ç¤ºæŸäº›æŒ‰é’®ï¼Œä½†ç¼–è¾‘åŠŸèƒ½éšè— */
        .mobile-only { display: none; }
        body.mobile .mobile-only { display: inline-flex; }
        /* å•†åº—å•†å“å¡ç‰‡ */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #d7e0ea;
        }
        .admin-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            z-index: 1000;
            display: none;
        }
        .admin-modal.show { display: block; }
        .overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4);
            z-index: 999;
            display: none;
        }
        .overlay.show { display: block; }
        /* PK åŒºåŸŸ */
        .pk-arena {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 1rem;
        }
        .pk-player {
            background: white;
            border-radius: 40px;
            padding: 1.5rem;
            text-align: center;
            flex: 1 1 200px;
        }
        .question-box {
            background: #e5ecf5;
            padding: 1.5rem;
            border-radius: 30px;
            font-size: 2rem;
            text-align: center;
        }
        /* æ™ºèƒ½å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .nav-tab span { display: none; }
            .nav-tab i { margin-right: 0; font-size: 1.3rem; }
            .user-section .coin-badge span { display: none; }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ  -->
    <div class="app-bar">
        <div class="logo"><i class="fas fa-home"></i> å®¶åº­Â·æ˜Ÿæ²³</div>
        <div class="user-section">
            <div class="coin-badge"><i class="fas fa-coins"></i> <span id="currentUserCoins">100</span></div>
            <select id="userSelect" class="user-selector">
                <option value="çˆ¸çˆ¸" data-avatar="ğŸ‘¨">ğŸ‘¨ çˆ¸çˆ¸</option>
                <option value="å¦ˆå¦ˆ" data-avatar="ğŸ‘©">ğŸ‘© å¦ˆå¦ˆ</option>
                <option value="å“¥å“¥" data-avatar="ğŸ§‘">ğŸ§‘ å“¥å“¥</option>
                <option value="å¦¹å¦¹" data-avatar="ğŸ‘§">ğŸ‘§ å¦¹å¦¹</option>
            </select>
        </div>
    </div>

    <!-- å¯¼èˆªé€‰é¡¹å¡ -->
    <div class="nav-tabs">
        <div class="nav-tab active" data-panel="chat"><i class="fas fa-comment-dots"></i><span> èŠå¤©</span></div>
        <div class="nav-tab" data-panel="cloud"><i class="fas fa-cloud-upload-alt"></i><span> äº‘ç›˜</span></div>
        <div class="nav-tab" data-panel="shop"><i class="fas fa-gift"></i><span> å•†åº—</span></div>
        <div class="nav-tab" data-panel="pk"><i class="fas fa-gamepad"></i><span> å°‘å„¿PK</span></div>
    </div>

    <!-- ä¸»é¢æ¿å®¹å™¨ -->
    <div class="panel-container" id="panelContainer">
        <!-- èŠå¤©é¢æ¿ -->
        <div class="panel active-panel" id="chatPanel">
            <div class="card">
                <div class="card-title"><i class="fas fa-comments"></i> å®¶åº­èŠå¤©å®¤</div>
                <div class="chat-messages" id="chatMessages"></div>
                <!-- å·¥å…·æ  -->
                <div class="chat-toolbar">
                    <input type="text" id="chatInput" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                    <div class="emojis">
                        <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ‘‹</span><span>ğŸ‰</span>
                    </div>
                    <button class="btn" id="sendTextBtn"><i class="fas fa-paper-plane"></i> å‘é€</button>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn" id="redPacketBtn"><i class="fas fa-redo-alt"></i> å‘çº¢åŒ…</button>
                    <button class="btn" id="chatFileBtn"><i class="fas fa-paperclip"></i> ä¼ æ–‡ä»¶</button>
                    <input type="file" id="chatFileInput" style="display: none;" multiple>
                </div>
                <div style="margin-top: 8px; font-size:0.9rem; color: gray;"><i class="fas fa-info-circle"></i> ç‚¹å‡»çº¢åŒ…å¯é¢†å– (è‡ªå·±å‘çš„ä¸èƒ½é¢†)</div>
            </div>
        </div>

        <!-- äº‘ç›˜é¢æ¿ -->
        <div class="panel" id="cloudPanel">
            <div class="card">
                <div class="card-title"><i class="fas fa-database"></i> å®¶åº­äº‘ç›˜ <span style="font-size:0.8rem; margin-left:auto;">ğŸ“±æ‰‹æœºå¯ä¸‹è½½ âš¡ç”µè„‘å¯ä¸Šä¼ /é¢„è§ˆ/ç¼–è¾‘</span></div>
                <button class="btn btn-primary" id="uploadCloudBtn"><i class="fas fa-upload"></i> ä¸Šä¼ åˆ°äº‘ç›˜</button>
                <input type="file" id="cloudFileInput" style="display: none;" multiple>
                <div style="margin: 15px 0;" class="file-grid" id="cloudFileList"></div>
                <div id="previewArea" style="border-top:1px solid #ccc; padding-top:10px;"></div>
            </div>
        </div>

        <!-- å•†åº—é¢æ¿ (è™šæ‹Ÿå•†å“) -->
        <div class="panel" id="shopPanel">
            <div class="card">
                <div class="card-title"><i class="fas fa-store"></i> è™šæ‹Ÿå•†å“åº— (é‡‘å¸äº¤æ˜“) <span style="font-size:0.7rem; margin-left:auto;">CTRL+Q ç®¡ç†å‘˜</span></div>
                <div id="shopItems"></div>
                <div id="tradeMessage" style="margin-top:10px; color: #b86b2c;"></div>
            </div>
        </div>

        <!-- å°‘å„¿å­¦ä¹ PKé¢æ¿ -->
        <div class="panel" id="pkPanel">
            <div class="card">
                <div class="card-title"><i class="fas fa-brain"></i> çŸ¥è¯†å¤§PK (èµ¢é‡‘å¸)</div>
                <div class="pk-arena">
                    <div class="pk-player" id="pkLeft">
                        <div style="font-size:3rem;">ğŸ‘§</div>
                        <h3>å¦¹å¦¹</h3>
                        <div>ğŸ’° <span id="pkLeftCoin">100</span></div>
                    </div>
                    <div class="pk-player" id="pkRight">
                        <div style="font-size:3rem;">ğŸ§‘</div>
                        <h3>å“¥å“¥</h3>
                        <div>ğŸ’° <span id="pkRightCoin">100</span></div>
                    </div>
                </div>
                <div class="question-box" id="pkQuestion">5 + 3 = ?</div>
                <div style="display:flex; gap:20px; justify-content:center; margin:20px;">
                    <button class="btn btn-primary" id="pkLeftBtn">å¦¹å¦¹å›ç­”</button>
                    <button class="btn btn-primary" id="pkRightBtn">å“¥å“¥å›ç­”</button>
                </div>
                <button class="btn" id="nextPkQuestion">ä¸‹ä¸€é¢˜</button>
                <p style="margin-top:10px;">ğŸ‘‰ è°å…ˆç­”å¯¹å¾—10é‡‘å¸</p>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜æ¨¡æ€æ¡† (CTRL+Q) -->
    <div class="overlay" id="modalOverlay"></div>
    <div class="admin-modal" id="adminModal">
        <h3><i class="fas fa-crown"></i> å•†å“ç®¡ç† (ç®¡ç†å‘˜)</h3>
        <div id="adminProductList"></div>
        <button class="btn btn-primary" id="addProductBtn">+ æ·»åŠ å•†å“</button>
        <button class="btn" id="closeAdminModal">å…³é—­</button>
    </div>

    <script>
        (function() {
            // ---------- è®¾å¤‡æ£€æµ‹ ç§»åŠ¨/ç”µè„‘ ----------
            function detectDevice() {
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
                document.body.classList.toggle('mobile', isMobile);
            }
            window.addEventListener('resize', detectDevice);
            detectDevice();

            // ---------- å…¨å±€çŠ¶æ€ ----------
            let users = [
                { name: 'çˆ¸çˆ¸', avatar: 'ğŸ‘¨', coins: 250 },
                { name: 'å¦ˆå¦ˆ', avatar: 'ğŸ‘©', coins: 300 },
                { name: 'å“¥å“¥', avatar: 'ğŸ§‘', coins: 180 },
                { name: 'å¦¹å¦¹', avatar: 'ğŸ‘§', coins: 150 }
            ];
            let currentUser = 'çˆ¸çˆ¸';    // å½“å‰é€‰ä¸­ç”¨æˆ·å

            // èŠå¤©æ¶ˆæ¯
            let messages = [
                { from: 'å¦ˆå¦ˆ', type: 'text', content: 'æ¬¢è¿æ¥åˆ°å®¶åº­èŠå¤©ï¼', timestamp: Date.now() - 50000 },
                { from: 'çˆ¸çˆ¸', type: 'text', content: 'å¯ä»¥å‘çº¢åŒ…ã€è¡¨æƒ…ã€æ–‡ä»¶å“¦', timestamp: Date.now() - 40000 },
            ];

            // äº‘ç›˜æ–‡ä»¶ (æ¨¡æ‹Ÿ + ä¸Šä¼ å­˜å‚¨ä¸ºå¯¹è±¡URL)
            let cloudFiles = [
                { id: 'f1', name: 'sample.mp3', type: 'audio/mpeg', size: '2.3 MB', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' }, // ç¤ºä¾‹éŸ³é¢‘
                { id: 'f2', name: 'sample.mp4', type: 'video/mp4', size: '5.1 MB', url: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4' },
                { id: 'f3', name: 'æ–‡æ¡£.pdf', type: 'application/pdf', size: '1.2 MB', url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
                { id: 'f4', name: 'ç¬”è®°.txt', type: 'text/plain', size: '2 KB', content: 'è¿™æ˜¯å®¶åº­å¤‡å¿˜å½•ã€‚', url: null },
            ];

            // å•†å“åˆ—è¡¨
            let shopItems = [
                { id: 'g1', name: 'ğŸ­ é­”æ³•æ£’', price: 30, stock: 5 },
                { id: 'g2', name: 'ğŸ“š æ•…äº‹ä¹¦', price: 45, stock: 3 },
                { id: 'g3', name: 'ğŸ§¸ æ¯›ç»’ç†Š', price: 70, stock: 2 },
            ];

            // PK é¢˜ç›®ç®€å•
            let currentQuestion = { text: '5 + 3', answer: 8 };
            const pkLeftUser = 'å¦¹å¦¹';
            const pkRightUser = 'å“¥å“¥';

            // ---------- è¾…åŠ©å‡½æ•° æ›´æ–°UI ----------
            function getUserCoins(name) {
                const u = users.find(u => u.name === name);
                return u ? u.coins : 0;
            }
            function updateUserCoins(name, delta) {
                const u = users.find(u => u.name === name);
                if (u) { u.coins += delta; }
                refreshCoinDisplay();
            }

            function refreshCoinDisplay() {
                document.getElementById('currentUserCoins').innerText = getUserCoins(currentUser);
                document.getElementById('pkLeftCoin').innerText = getUserCoins('å¦¹å¦¹');
                document.getElementById('pkRightCoin').innerText = getUserCoins('å“¥å“¥');
            }

            // æ¸²æŸ“èŠå¤©
            function renderChat() {
                const container = document.getElementById('chatMessages');
                let html = '';
                messages.forEach((msg, idx) => {
                    const user = users.find(u => u.name === msg.from) || { avatar: 'ğŸ‘¤' };
                    html += `<div class="message" data-msg-index="${idx}">`;
                    html += `<div class="msg-avatar">${user.avatar || 'ğŸ‘¤'}</div>`;
                    html += `<div class="msg-bubble">`;
                    html += `<div class="msg-info"><span>${msg.from}</span> <span>${new Date(msg.timestamp).toLocaleTimeString()}</span></div>`;
                    if (msg.type === 'text') html += `<div>${msg.content}</div>`;
                    else if (msg.type === 'redpacket') {
                        let grabbedClass = msg.grabbedBy ? 'grabbed' : '';
                        html += `<div class="redpacket ${grabbedClass}" data-redpacket-idx="${idx}">ğŸ§§ çº¢åŒ…: ${msg.amount} é‡‘å¸ ${msg.grabbedBy ? '(å·²é¢†)' : 'ç‚¹å‡»é¢†å–'}</div>`;
                    } else if (msg.type === 'file') {
                        html += `<div><i class="fas fa-file"></i> <a href="${msg.fileUrl}" target="_blank">${msg.fileName}</a></div>`;
                    } else if (msg.type === 'emojis') {
                        html += `<div style="font-size:2rem;">${msg.content}</div>`;
                    }
                    html += `</div></div>`;
                });
                container.innerHTML = html;
                // çº¢åŒ…ç‚¹å‡»ç›‘å¬
                document.querySelectorAll('.redpacket').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const idx = e.currentTarget.dataset.redpacketIdx;
                        if (!idx) return;
                        const msg = messages[idx];
                        if (!msg || msg.type !== 'redpacket' || msg.grabbedBy) return;
                        if (msg.from === currentUser) { alert('ä¸èƒ½é¢†è‡ªå·±çš„çº¢åŒ…'); return; }
                        msg.grabbedBy = currentUser;
                        updateUserCoins(currentUser, msg.amount);
                        updateUserCoins(msg.from, -msg.amount);  // ä»å‘é€è€…æ‰£ (å·²ç»å‘é€æ—¶æ‰£è¿‡äº†, ä½†ç¡®ä¿é€»è¾‘)
                        renderChat();
                        refreshCoinDisplay();
                    });
                });
            }

            // æ¸²æŸ“äº‘ç›˜
            function renderCloud() {
                const list = document.getElementById('cloudFileList');
                let html = '';
                cloudFiles.forEach((f, idx) => {
                    const isMobile = document.body.classList.contains('mobile');
                    html += `<div class="file-item" data-file-idx="${idx}">`;
                    html += `<div class="file-icon"><i class="fas fa-${f.type.startsWith('audio')?'music':f.type.startsWith('video')?'video':f.type==='application/pdf'?'file-pdf':'file-alt'}"></i></div>`;
                    html += `<div class="file-name">${f.name}</div>`;
                    html += `<div class="file-actions">`;
                    // ä¸‹è½½ (æ‰‹æœº + ç”µè„‘)
                    html += `<button class="btn download-file" data-idx="${idx}"><i class="fas fa-download"></i> ä¸‹è½½</button>`;
                    if (!isMobile) {  // ç”µè„‘é¢å¤–æ“ä½œ
                        html += `<button class="btn preview-file" data-idx="${idx}"><i class="fas fa-eye"></i> é¢„è§ˆ</button>`;
                        if (f.type === 'text/plain' || f.name.endsWith('.txt')) {
                            html += `<button class="btn edit-file" data-idx="${idx}"><i class="fas fa-edit"></i> ç¼–è¾‘</button>`;
                        }
                    } else {
                        // æ‰‹æœºé¢„è§ˆä¹Ÿä¿ç•™ (å¯ä»¥é¢„è§ˆMP3/MP4)
                        html += `<button class="btn preview-file" data-idx="${idx}"><i class="fas fa-play"></i> é¢„è§ˆ</button>`;
                    }
                    html += `</div></div>`;
                });
                list.innerHTML = html;
                // ç»‘å®šäº‹ä»¶
                document.querySelectorAll('.download-file').forEach(b => b.addEventListener('click', (e) => downloadFile(e.target.dataset.idx || e.target.closest('button').dataset.idx)));
                document.querySelectorAll('.preview-file').forEach(b => b.addEventListener('click', (e) => previewFile(e.target.dataset.idx || e.target.closest('button').dataset.idx)));
                document.querySelectorAll('.edit-file').forEach(b => b.addEventListener('click', (e) => editFile(e.target.dataset.idx || e.target.closest('button').dataset.idx)));
            }

            function downloadFile(idx) { const f = cloudFiles[idx]; if (f.url) window.open(f.url); else if (f.content) { const blob = new Blob([f.content], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = f.name; a.click(); } else alert('æ— å†…å®¹å¯ä¸‹è½½'); }
            function previewFile(idx) { const f = cloudFiles[idx]; if (f.url) window.open(f.url); else if (f.content) { const win = window.open('', '_blank'); win.document.write(`<pre>${f.content}</pre>`); } else alert('æ— æ³•é¢„è§ˆ'); }
            function editFile(idx) { const f = cloudFiles[idx]; if (f.type === 'text/plain' || f.name.endsWith('.txt')) { const newContent = prompt('ç¼–è¾‘æ–‡æœ¬å†…å®¹:', f.content || ''); if (newContent !== null) { f.content = newContent; renderCloud(); } } else alert('åªèƒ½ç¼–è¾‘æ–‡æœ¬æ–‡ä»¶'); }

            // å•†åº—æ¸²æŸ“
            function renderShop() {
                const container = document.getElementById('shopItems');
                let html = '';
                shopItems.forEach((item, i) => {
                    html += `<div class="shop-item"><span><b>${item.name}</b>  ğŸ’°${item.price}  (å‰©${item.stock})</span>`;
                    html += `<button class="btn buy-shop" data-idx="${i}">è´­ä¹°</button></div>`;
                });
                container.innerHTML = html;
                document.querySelectorAll('.buy-shop').forEach(b => b.addEventListener('click', (e) => {
                    const idx = e.target.dataset.idx;
                    const item = shopItems[idx];
                    if (item.stock <= 0) { document.getElementById('tradeMessage').innerText = 'âŒ æ²¡è´§å•¦'; return; }
                    const user = users.find(u => u.name === currentUser);
                    if (user.coins < item.price) { document.getElementById('tradeMessage').innerText = 'ğŸ’° é‡‘å¸ä¸è¶³'; return; }
                    user.coins -= item.price;
                    item.stock -= 1;
                    refreshCoinDisplay();
                    renderShop();
                    document.getElementById('tradeMessage').innerHTML = `âœ… äº¤æ˜“æˆåŠŸ: è·å¾— ${item.name}  (äº¤æ˜“åè¯è¯­: å®¶åº­å…±äº«å¿«ä¹)`;
                }));
            }

            // ç®¡ç†å‘˜æ¸²æŸ“å•†å“åˆ—è¡¨
            function renderAdmin() {
                const container = document.getElementById('adminProductList');
                let html = '';
                shopItems.forEach((item, i) => {
                    html += `<div style="margin:10px 0;">${item.name}  ğŸ’°${item.price} ğŸ“¦${item.stock} <button data-index="${i}" class="btn admin-del">åˆ é™¤</button></div>`;
                });
                container.innerHTML = html;
                document.querySelectorAll('.admin-del').forEach(b => b.addEventListener('click', (e) => {
                    const idx = e.target.dataset.index;
                    shopItems.splice(idx, 1);
                    renderAdmin(); renderShop();
                }));
            }

            // å‘çº¢åŒ…é€»è¾‘
            document.getElementById('redPacketBtn').addEventListener('click', () => {
                let amount = prompt('è¾“å…¥çº¢åŒ…é‡‘å¸æ•°é‡ (1-100)', '10');
                amount = parseInt(amount);
                if (isNaN(amount) || amount <= 0) return;
                const user = users.find(u => u.name === currentUser);
                if (user.coins < amount) { alert('é‡‘å¸ä¸è¶³'); return; }
                user.coins -= amount;
                messages.push({ from: currentUser, type: 'redpacket', amount: amount, timestamp: Date.now(), grabbedBy: null });
                renderChat(); refreshCoinDisplay();
            });

            document.getElementById('sendTextBtn').addEventListener('click', () => {
                const input = document.getElementById('chatInput');
                if (input.value.trim() !== '') {
                    messages.push({ from: currentUser, type: 'text', content: input.value, timestamp: Date.now() });
                    input.value = '';
                    renderChat();
                }
            });
            document.querySelectorAll('.emojis span').forEach(s => s.addEventListener('click', (e) => {
                messages.push({ from: currentUser, type: 'emojis', content: e.target.innerText, timestamp: Date.now() });
                renderChat();
            }));

            // èŠå¤©ä¼ æ–‡ä»¶
            document.getElementById('chatFileBtn').addEventListener('click', ()=> document.getElementById('chatFileInput').click());
            document.getElementById('chatFileInput').addEventListener('change', function(e) {
                for (let f of e.target.files) {
                    const url = URL.createObjectURL(f);
                    messages.push({ from: currentUser, type: 'file', fileName: f.name, fileUrl: url, timestamp: Date.now() });
                }
                renderChat();
                this.value = '';
            });

            // äº‘ç›˜ä¸Šä¼ 
            document.getElementById('uploadCloudBtn').addEventListener('click', ()=> document.getElementById('cloudFileInput').click());
            document.getElementById('cloudFileInput').addEventListener('change', function(e) {
                for (let f of e.target.files) {
                    const isText = f.type.startsWith('text/') || f.name.endsWith('.txt');
                    if (isText) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            cloudFiles.push({ id: 'f'+Date.now(), name: f.name, type: f.type, size: (f.size/1024).toFixed(1)+' KB', content: ev.target.result, url: null });
                            renderCloud();
                        };
                        reader.readAsText(f);
                    } else {
                        const url = URL.createObjectURL(f);
                        cloudFiles.push({ id: 'f'+Date.now(), name: f.name, type: f.type, size: (f.size/1024).toFixed(1)+' KB', url: url });
                        renderCloud();
                    }
                }
                this.value = '';
            });

            // ç®¡ç†å‘˜ CTRL+Q
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'q') {
                    e.preventDefault();
                    document.getElementById('adminModal').classList.add('show');
                    document.getElementById('modalOverlay').classList.add('show');
                    renderAdmin();
                }
            });
            document.getElementById('closeAdminModal').addEventListener('click', ()=>{
                document.getElementById('adminModal').classList.remove('show');
                document.getElementById('modalOverlay').classList.remove('show');
            });
            document.getElementById('addProductBtn').addEventListener('click', ()=>{
                const name = prompt('å•†å“å');
                if (!name) return;
                const price = parseInt(prompt('ä»·æ ¼')) || 10;
                const stock = parseInt(prompt('åº“å­˜')) || 1;
                shopItems.push({ id: 'g'+Date.now(), name, price, stock });
                renderAdmin(); renderShop();
            });

            // åˆ‡æ¢é¢æ¿
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active-panel'));
                    document.getElementById(tab.dataset.panel + 'Panel').classList.add('active-panel');
                });
            });

            // ç”¨æˆ·åˆ‡æ¢
            document.getElementById('userSelect').addEventListener('change', (e) => {
                currentUser = e.target.value;
                refreshCoinDisplay();
            });

            // PK é€»è¾‘
            function generateQuestion() {
                const a = Math.floor(Math.random()*10)+1, b = Math.floor(Math.random()*10)+1;
                currentQuestion = { text: `${a} + ${b}`, answer: a+b };
                document.getElementById('pkQuestion').innerText = currentQuestion.text + ' = ?';
            }
            document.getElementById('nextPkQuestion').addEventListener('click', generateQuestion);
            function pkAnswer(playerName) {
                const ans = prompt('è¾“å…¥ç­”æ¡ˆ (æ•°å­—)');
                if (parseInt(ans) === currentQuestion.answer) {
                    updateUserCoins(playerName, 10);
                    alert('âœ… æ­£ç¡®! +10é‡‘å¸');
                    generateQuestion();
                } else alert('âŒ ä¸å¯¹å“¦');
            }
            document.getElementById('pkLeftBtn').addEventListener('click', ()=> pkAnswer('å¦¹å¦¹'));
            document.getElementById('pkRightBtn').addEventListener('click', ()=> pkAnswer('å“¥å“¥'));

            // åˆå§‹åŒ–æ¸²æŸ“
            renderChat(); renderCloud(); renderShop(); refreshCoinDisplay(); generateQuestion();
        })();
    </script>
</body>
</html>